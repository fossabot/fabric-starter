# Инструкция по подключению к сети Факторинг

## Цель документа:
* обеспечить возможность самостоятельного развертывания узла для участия в децентрализованной сети на платформе HyperLedger Fabric
* обеспечить возможность по выполнению специальных настроек для использования смарт-контрактов ( ChainCode) по автоматизации процессов факторинга
## Термины и определения
* Канал - сущность в терминологии Hyperledger Fabric, соответствующая отдельной цепочке блоков транзакций, которая доступна и распространяется только между ограниченным кругом организаций и упорядочивающих узлов. Каждый канал характеризуется набором полномочий подключенных участников и правилами изменения полномочий
* Консорциум - перечень полноправных участников Сети. С технической точки зрения смарт-контракты Факторинг настроены таким образом, что не являющиеся членами консорциума организации имеет доступ только для просмотра данных в каналах

## Компонентный состав решения
* узел (`peer`) - обязательный компонент, docker-container, внутри которого исполняет код, реализующий базовую бизнес-логику платформы: сетевое взаимодействие с другими участниками, взаимодействие с хранилищем (`ledger`), развертывание смарт-контрактов (`ChainCode`)
* Смарт-контракт (`ChainCode`) - массив компонент, представляющих собой docker-container, содержащие исполняемый код, реализующий бизнес-логику по изменению и получению данных в ledger
* упорядочивающий узел (`Orderer`) - опциональный компонент, docker-container, внутри которого исполняется код получения транзакций от peer, проверка их корректности, упорядочивание и формирование блоков
* удостоверяющий цент (`CA`) - обязательный компонент, docker-container, содержащий в себе хранилище доверенных сертификатов других участников, а также выпускающий сертификаты для дополнительных узлов внутри предприятия
* вспомогательные сервисы (`Backend`) - опциональный компонент, docker-container, внутри которого исполняется код, предоставляющий возможность пользователям просматривать данные из ledger и исполнять смарт-контракты в браузере
* API сервер (`API Node`) -


## Этапы подключения участника
Можно выделить два основных этапа развертывания решения.
### Подключение к сети
Данный этап является общим для всех решений с использованием HyperLedger Fabric. Для успешного функционирования узла предприятия и взаимодействия с другими узлами необходимо выполнить описанные ниже действия
#### Инфраструктура
1. Выделить в сети предприятия или в облачной инфраструктуре сервер со следующими параметрами:
    * Ресурсы не менее чем 2 CPU, 2 Gb RAM, 10 GB HDD
    * Рекомендуемая ОС: Ubuntu LTS
    * Установленное ПО: Docker, Docker-compose

2. Обеспечить сетевой доступ по следующим портам и протоколам:

|Направление|Протокол|Порт|
|--|--|--|
|Inbound|TCP|7054|

3. Указать адреса других участников сети в списке `/etc/hosts` : TBD

Пример файла: TBD
#### Развертывание контейнеров типовой конфигурации
1. Войти в консоль сервера
2. Загрузить скрипты в виде zip-файла, либо клонировать репозиторий https://github.com/olegabu/fabric-starter
3. перейти в папку fabric-starter: `cd fabric-starter`
4. Выполнить команды

       EXPORT ORG="" #краткое название организации
       EXPORT DOMAIN="factoring"
       EXPORT CHAINCODE_VERSION = #версия смарт-контракта
       ./generate-peer.sh
       docker-compose up -d
5. В результате должны появиться контейнеры со следующими именами:

    * peer0.`org`.`domain`.com - Узел участника
    * peer1.`org`.`domain`.com - Узел участника
    * api.`org`.`domain`.com - API сервер
    * ca.`org`.`domain`.com - Удостоверяющий центр
    * cli.`org`.`domain`.com - Сервер для выполнения служебных команд
    * www.`org`.`domain`.com - Сервер Nginx
 ### Присоединение к каналам
 Для участия в сети необходимо явным образом  выраженное согласие других участников, которое с технической точки зрения выражается в следующем:
 1. Организация, обладающая упорядочивающим узлом (`Orderer`) должна пригласить нового участника в круг участников ( консорциум), выполнив команду: `./consortium-add-org.sh "$ORG"` . Кроме того, информация об адресах компонентов новой организации должны быть переданы и зафиксированы в настройках узлов других участников Сети.
 2. Организация, создавшая канал, должна пригласить нового участника в канал, выполнив команду для каждого канала: `./channel-add-org.sh $CHANNEL_NAME $ORG`
 **Примечание**:
 * `$ORG` - название новой организации, указанное при развертывании узлов
 *
### Развертывание веб-приложения:
Для удобства работы со смарт-контрактом Факторинг было разработано небольшое приложение, обеспечивающее формирование отчетности и работу с файлами. Поскольку, оно не относится к типовой конфигурации, то инструкция по развертыванию вынесена в отдельный раздел, а установка выполняется отдельной командой

         docker run -d -p 80:80 ...
### Развертывание смарт-контрактов
1. Скопировать папку c кодом смарт-контрактов в папку `fabric-starter/chaincode/java`
2. Выполнить команду:
```bash
./chaincode-install.sh factor_scala $CHAINCODE_VERSION /opt/chaincode/java/factoring  java
```

### Проверить работоспособность приложения
Зайти на страницу http://hostname/login