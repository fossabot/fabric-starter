# Инструкция по подключению к сети Факторинг

## Цель документа

* обеспечить возможность самостоятельного развертывания узла для участия в децентрализованной сети на платформе HyperLedger Fabric
* обеспечить возможность по выполнению специальных настроек для использования смарт-контрактов ( ChainCode) по автоматизации процессов факторинга

## Термины и определения

* Канал - сущность в терминологии Hyperledger Fabric, соответствующая отдельной цепочке блоков транзакций, которая доступна и распространяется только между ограниченным кругом организаций и упорядочивающих узлов. Каждый канал характеризуется набором полномочий подключенных участников и правилами изменения полномочий
* Консорциум - перечень полноправных участников Сети. С технической точки зрения смарт-контракты Факторинг настроены таким образом, что не являющиеся членами консорциума организации имеет доступ только для просмотра данных в каналах

## Компонентный состав решения

* узел (`peer`) - обязательный компонент, docker-container, внутри которого исполняет код, реализующий базовую бизнес-логику платформы: сетевое взаимодействие с другими участниками, взаимодействие с хранилищем (`ledger`), развертывание смарт-контрактов (`ChainCode`)
* Смарт-контракт (`ChainCode`) - массив компонент, представляющих собой docker-container, содержащие исполняемый код, реализующий бизнес-логику по изменению и получению данных в ledger
* упорядочивающий узел (`Orderer`) - опциональный компонент, docker-container, внутри которого исполняется код получения транзакций от peer, проверка их корректности, упорядочивание и формирование блоков
* удостоверяющий цент (`CA`) - обязательный компонент, docker-container, содержащий в себе хранилище доверенных сертификатов других участников, а также выпускающий сертификаты для дополнительных узлов внутри предприятия
* вспомогательные сервисы (`Backend`) - опциональный компонент, docker-container, внутри которого исполняется код, предоставляющий возможность пользователям просматривать данные из ledger и исполнять смарт-контракты в браузере
* API сервер (`API Node`) -

## Этапы подключения участника

Можно выделить два основных этапа развертывания решения.

### Подключение к сети

Данный этап является общим для всех решений с использованием HyperLedger Fabric. Для успешного функционирования узла предприятия и взаимодействия с другими узлами необходимо выполнить описанные ниже действия

#### Инфраструктура

1. Выделить в сети предприятия или в облачной инфраструктуре сервер со следующими параметрами:
    * Ресурсы не менее чем 2 CPU, 2 Gb RAM, 10 GB HDD
    * Рекомендуемая ОС: Ubuntu LTS
    * Установленное ПО: Docker, Docker-compose

2. Обеспечить сетевой доступ по следующим портам и протоколам:

    |Откуда|Куда|Протокол|Порт|
    |--|--|--|--|
    |*|localhost|TCP|7053|
    |*|localhost|TCP|7051|
    |*|localhost|TCP|80|
    |localhost|52.174.22.75|TCP|7053|
    |localhost|52.174.22.75|TCP|7051|
    |localhost|52.174.22.75|TCP|80|
    |localhost|104.40.205.94|TCP|7053|
    |localhost|104.40.205.94|TCP|7051|
    |localhost|104.40.205.94|TCP|80|


3. Указать адреса других участников сети в списке `/etc/hosts` :

```
52.174.22.75 www.mvideo.factoring
52.174.22.75 peer0.mvideo.factoring
52.174.22.75 peer1.mvideo.factoring

104.40.205.94 www.factoring
104.40.205.94 orderer.factoring
```

4. Настроить DNS для контейнеров:
```bash
sudo apt install dnsmasq
```

Проверить статус службы:

```bash
systemctl status dnsmasq
```

Найти адрес шлюза, который предоставляет Docker для внутренней подсети
```
ip addr | grep docker0
```

*Пример результата*:
  **docker0**: <BROADCAST,MULTICAST,UP,LOWER_UP>
  ...
    inet **`172.17.0.1`**/16

Добавить адрес в конфигурационный файл

```bash
sudo nano /etc/docker/daemon.json
```

Пример

```javascript
{
    "dns": ["172.17.0.1", "172.18.0.1", "8.8.8.8", "8.8.4.4"]
}
```

Перезапустить службу Docker

```bash
sudo service docker restart
```

Создать конфигурационный файл для bridge сети

```
sudo mkdir -p /etc/NetworkManager/dnsmasq.d
sudo nano /etc/NetworkManager/dnsmasq.d/docker-bridge.conf
```

Добавить в него те же самые адреса:

```
listen-address=172.17.0.1
listen-address=172.18.0.1
```

Перезапустить службу:

```
sudo service dnsmasq restart    
```

#### Развертывание контейнеров типовой конфигурации

1. Войти в консоль сервера
2. Клонировать этот репозиторий
3. Перейти в папку fabric-starter: `cd fabric-starter`
4. Выполнить команды

       EXPORT ORG="" #краткое название организации
       EXPORT DOMAIN="factoring"
       EXPORT CHAINCODE_VERSION = #версия смарт-контракта
       ./generate-peer.sh
       docker-compose -f docker-compose.yaml -f ports.yaml up -d
5. В результате должны появиться контейнеры со следующими именами:

    * peer0.`org`.`domain`.com - Узел участника
    * peer1.`org`.`domain`.com - Узел участника
    * api.`org`.`domain`.com - API сервер
    * ca.`org`.`domain`.com - Удостоверяющий центр
    * cli.`org`.`domain`.com - Сервер для выполнения служебных команд
    * www.`org`.`domain`.com - Сервер Nginx

### Присоединение к каналам

 После настройки и проверки сетевого соединения, необходимо обеспечить включение организации (т.е. ее публичного ключа) в список доверенных участников. Для участия в сети необходимо явным образом  выраженное согласие других участников, которое с технической точки зрения выражается в следующем:

 1. Организация, обладающая упорядочивающим узлом (`Orderer`) должна пригласить нового участника в круг участников ( консорциум), выполнив команду: `./consortium-add-org.sh "$ORG"` . Кроме того, информация об адресах компонентов новой организации должны быть переданы и зафиксированы в настройках узлов других участников Сети.*Эту команда сработает только у уполномоченной организации, от лица подключаемой организации выполнять бесполезно*
 2. Организация, создавшая канал, должна пригласить нового участника в канал, выполнив команду для каждого канала: `./channel-add-org.sh $CHANNEL_NAME $ORG`. *Эту команда сработает только у уполномоченной организации, от лица подключаемой организации выполнять бесполезно*
 3. Необходимо от лица подключаемой организации выполнить комманду для каждого планируемого к использованию канала: `./channel-join.sh $CHANNEL_NAME `  

 **Примечание**:

* `$ORG` - название новой организации, указанное при развертывании узлов
* `$CHANNEL_NAME` - название канала, которое можно получить от его создателя

### Развертывание веб-приложения:
Для удобства работы со смарт-контрактом Факторинг было разработано небольшое приложение, обеспечивающее формирование отчетности и работу с файлами. Поскольку, оно не относится к типовой конфигурации, то инструкция по развертыванию вынесена в отдельный раздел, а установка выполняется отдельной командой

        docker-compose -f factor-network/docker/backend-compose.yaml up -d
### Развертывание смарт-контрактов

```bash
export CHAINCODE_VERSION=1.0
./chaincode-install.sh factor_scala $CHAINCODE_VERSION /opt/chaincode/java/factoring  java

```

### Проверить работоспособность приложения
Зайти на страницу http://hostname:5500/login