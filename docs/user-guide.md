# Приложение Факторинг

Цели документа:

* Предоставить обзор архитектуры решения для целей сопровождения и администрирования
* Обзор решения с точки зрения использования электронной подписи
* Описать экранные формы и сценарии использования решения

## Обзор архитектуры

Решение базируется на платформе Hyperledger Fabric и представляет собой сеть для частично децентрализованного хранения и управления данными. В случае с Факторинг храняться контракты и поставки. Основная цель решения - автоматически проверять, что одна и та же поставка была подтверждена Фактором и Дебитором.

### Компонентный состав решения

* узел (`peer`) - обязательный компонент, docker-container, внутри которого исполняет код, реализующий базовую бизнес-логику платформы: сетевое взаимодействие с другими участниками, взаимодействие с хранилищем (`ledger`), развертывание смарт-контрактов (`ChainCode`)
* Смарт-контракт (`ChainCode`) - массив компонент, представляющих собой docker-container, содержащие исполняемый код, реализующий бизнес-логику по изменению и получению данных в ledger
* упорядочивающий узел (`Orderer`) - опциональный компонент, docker-container, внутри которого исполняется код получения транзакций от peer, проверка их корректности, упорядочивание и формирование блоков
* удостоверяющий цент (`CA`) - обязательный компонент, docker-container, содержащий в себе хранилище доверенных сертификатов других участников, а также выпускающий сертификаты для дополнительных узлов внутри предприятия
* вспомогательные сервисы (`Backend`) - опциональный компонент, docker-container, внутри которого исполняется код, предоставляющий возможность пользователям просматривать данные из ledger и исполнять смарт-контракты в браузере
* API сервер (`API Node`) - адаптер к Hyperledger Fabric SDK с набором REST сервисов для выполнения типовых операций

### Топология Сети

На текущий момент в сети всего два активных участника: Мвидео и Сбербанк-Факторинг. Работоспособность Сети в текущем состоянии зависит от:

* Корректности настройки DNS и `dnsmasq` для обеспечения корректного обнаружения участниками друг друга в сети
* Работоспособности Упорядочивающего Узла СБФ. В будущем при присоединении новых участников возможно обновление конфигурации Сети для использования иного алгоритма консенсуса с использованием протоколов RAFT, Smart BFT

В рамках развертывания Сети были проведены следующие работы:

1. Развертывание программных компонент на стороне СБФ, Мвидео
2. Настройка DNS для обеспечения возможности обращения к узлу по DNS имени
3. Выпуск самоподписанных сертификатов на основе алгоритма ECDSA с указанием идентификатора организации
4. Создание консорциума с единственным участником - СБФ, добавление  в консорциум Мвидео. При этом произошел обмен и сохранение сертификатов в качестве доверенных сторон
5. Создание каналов и добавление в них СБФ и Мвидео
6. Развертывание смарт-контрактов для взаимодействия с хранилищем данных (`ledger`)

## Использование ЭП

Каждый Узел и Упорядочивающий Узел оперируют:

* ключом для создания ЭП, который хранится локально на сервере с соответствующим ПО. В Сети Факторинг используются ключи на основе эллиптических кривых ( ECDSA). Технически возможно обновить решения для работы с ГОСТ 3410, ГОСТ 3411
* ключами других участников для проверки подписи
* сертификатами других участников для проверки их полномочий. Сертификат является самоподписанным, то есть не подписан аккредитованным УЦ

С точки зрения ст. 6 и 7 в N 63-ФЗ "Об Электронной Подписи" данный мезанизм может быть классифицирован как усиленная неквалифицированная подпись, причем в ПО отсуствуют персональные данные или иные обязательные к криптографической защите и сертификации сведения.

### Процесс обработки транзакции

С точки зрения платформы изменение любого вида данных как на уровне конкретного приложения ( Факторинг), так и на уровне конфигурации Сети, может быть осуществлено только с помощью так называемой Транзакции. Транзакция изначально включает в себя:

* набор исходных данных
* параметры для изменения (смарт-контракт и аргументы конкретного вызова)

Инициатором транзакции может выступить какой-либо сотрудник организации с доступом к приложению Факторинг. В момент первого входа в Приложение для логина сотрудника выпускается ключ создания подписи (секретный ключ), ключ проверки подписи (публичный ключ) и сертификат с указаним логина. В каждой новой сессии пользователя используеся этот набор данных для создания транзакций. Этапы обработки транзакций:

1. Сотрудник инициирует загрузку данных (то есть создает транзакцию)
2. Транзакция с ЭП сотрудника отправляется на проверку в узлы СБФ и Мвидео. В процессе проверки происходит верификация подписи, сравнение данных с текущим состоянием Узла и подготовка результата вычислений ( то есть загрузки).
3. Подписанные ЭП организаций ответы возвращаются в Приложение
4. Транзакция вместе с результатами ее проверки отправляется в Упорядочиваюший Узел, который проверят ЭП организаций и в случае успеха публикует новый подписанный ЭП блок транзакций с уведомлением об изменении данных ( в нашем случае - о загрузке новых Заказов)
5. Узлы СБФ и Мвидео получают новый блок от Упорядочивающего Узла, проверяют его ЭП и в случае успеха применяют транзакции из блока к собственному хранилищу даных (`ledger`)

Таким образом, в хранилище каждой из организации храняться копии всех изменений данных, причем каждое из них содержит четыре ЭП.

### Модель данных

Каждая уникальная строка в загружаемых файлах считается Документом. Все документы с одинаковым идентификатором (см. Загрузка данных о поставках) привязываются к общей сущности Заказ, таким образом для каждого заказа всегда хранится состояние в виде флагов наличия подтверждений приемки и уступки, а также загруженные документы на случай различий в дополнительных полях. 

## Инструкция пользователя

### Экранные формы

#### Список контрактов

В данной форме отображается список контрактов, то есть долгосрочных соглашений между огранизациями по финансированию поставок. Данные по поставкам конкретного контракта недоступны организациям за его пределами. Внутри контракта все участники видят все данные.

#### Список поставок

Экран содержит все экземпляры Заказов, причем в случае наличия Документа о приемке или уступке в экранной форме отображается галочка в соответствующей графе. Экранная форма автоматически обновляется при загрузке нового файла. В случае отсутствия данных желательно проверить условия фильтра. По умолчанию фильтр установлен для просмотра заказов за последнюю неделю ( по соответствующему полю в файле).

#### Моя организация

В данной форме отображаются данные организации, которая контролирует используемый узел. Указанная в роль (Factor/Buyer/Seller) используется для того, чтобы автоматически определять тип загружаемого файла - список заказов для уступки (Factor), подтверждение приемки (Buyer)

#### Организации

Данный из этой формы являются публичными для всей Сети, используются для отображения списка контрактов и для удобства при подключении к Сети. Важной информацией является идентификатор организации, на который выпускается ключ и сертификат для работы в Сети, которым подписываются все транзакции.

### Сценарии использования

#### Загрузка данных о поставках

Пользователь организации может инициировать загрузку данных о поставках. В зависимости от типа организации пользователь может загрузить либо данные об уступке (Factor, Seller), либо данные о приемке товара. Для каждого типа данных зафиксирован набор атрибутов. Дополнительные важные правила:

* уникальным идентификатором строки считается совокупность из нормализованного наименования поставщика, текста заголовка и даты поставки
* повторная загрузка одного и того же документа (с тем же идентификатором) в рамках одного файла считается корректировкой, и обрабатывается как один документ с совокупной суммой
* повторная загрузка одного и того же документа (с тем же идентификатором) в разных файлах приводит к замене данных

#### Выгрузка сверочного отчета

Пользователь может выгрузить сверочный отчет за все время в виде CSV файла. В файле фигурируют те же данные, что и в загруженных файлах и дополнительно:

* "хэш совпал": данный Заказ был подвтержден с обеих сторон
* "сумма совпала": для данного Заказа было найдено только подтверждение приемки или подтверждение уступки ( возможно из-за ошибки в данных), однако есть заказ с другим идентификатором, сумма которого в точности совпала с данным, таким образом наличие положительного значения в этой графе может указать на то, что эти две строки а саммом деле - это один и тот же заказ.
* "сумма отличается": данный Заказ был подвтержден с обеих сторон, но суммы в подтверждениях не совпали

#### Заключение нового контракта

На данный момент процесс не автоматизирован, поскольку включает в себя настройку взаимодействия между узлами на сетевом уровне

## Типовые инциденты

### При попытке входа в приложение ничего не происходит

В момент входа выполняется запрос к CA для проверки учетных данных, а также обращение к смарт-контрактов для получения необходимых для отборажения данных на домашней страницы. Сама же страница вместе с кодом кэшируется в браузере. Для дальнейшей диагностике предлагается в консоли браузера посмотрать на результаты http запросов к сервисам Узла. Возможно, Узел организации недоступен. В качестве альтернативы можно выполнить запрос с помощью curl из инструкции по подключению.

### При загрузке данных отображается ошибка 503 Service Unavailable

В приложении стоит автоматический таймаут 60 секунд на выполнение операции. При попытке загрузке файлов примерно от 300 КБ ( 5000 заказов) возможны подобные проблемы. Желательно разбить файл на части. Планируется исправить в следующих версиях